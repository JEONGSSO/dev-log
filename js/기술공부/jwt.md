# JSON Web Token 이하 JWT

---
## 특징
JSON Web Token (JWT) 은 웹표준 (RFC 7519) 으로서 두 개체에서 JSON 객체를 사용하여 가볍고 자가수용적인 (self-contained) 방식으로 정보를 안전성 있게 전달해줍니다.

오랜기간 세션을 유지하며, 보안을 강화한 점이다.
매번 요청할 때 토큰과 서버로 요청이 날라가는데, 이때 토큰 탈취가 일어날 수 있다.
로그인에 사용하는 토큰은 Access Token(AT)이다. 그 후에 AT가 만료되면, Refresh Token(RT)으로 다시 AT를 발급 받아서 로그인 한다.

클라이언트 쪽에서 RT를 이용해 AT를 재발급하는 로직을 구현해야 한다.

JWT는 AT가 주기적으로 변경이 되기 때문에 사용 중 만료가 발생할 수 있다.
1초 만료시간이 남은 토큰 사용 시, 1초 보다 지연되면 서버쪽에서는 토큰 사용을 못하기 때문이다.

---
## JWT구조 

Header, Payload, Signature의 3부분으로 이루어지며, Json 형태인 각 부분은 Base64로 인코딩 되어 표현.
각각 부분을 "."(dot)으로 이어준다.

---
### HEADER
typ : 토큰의 타입을 지정 JWT 등등
alg : 알고리즘 방식을 지정, 서명 및 토큰 검증에 사용 HS256, RSA 등등

---
### PAYLOAD
페이로드에는 토큰에서 사용할 정보의 조각들인 클레임(Claim)이 담겨있다.

#### 등록된 클레임
토큰 정보를 표현하기 위해 이미 정해진 종류의 데이터들로

선택적으로 작성 가능하며 사용할 것을 권장, key는 길이 3의 String, value는 unique한 값을 사용 주로 사용자의 이메일

iss: 토큰 발급자(issuer)
sub: 토큰 제목(subject)
aud: 토큰 대상자(audience)
exp: 토큰 만료 시간(expiration), NumericDate 형식으로 되어 있어야 함 ex) 1480849147370
nbf: 토큰 활성 날짜(not before), 이 날이 지나기 전의 토큰은 활성화되지 않음
iat: 토큰 발급 시간(issued at), 토큰 발급 이후의 경과 시간을 알 수 있음
jti: JWT 토큰 식별자(JWT ID), 중복 방지를 위해 사용하며, 일회용 토큰(Access Token) 등에 사용

#### 비, 공개 클레임
공개: 사용자 정의 클레임으로, 공개용 정보를 위해 사용.
비공개: 서버와 클라이언트 사이에 임의로 지정한 정보를 저장.

---
### Signature
토큰을 인코딩하거나 유효성 검증을 할 때 사용하는 고유한 암호화 코드.

헤더와 페이로드의 값을 각각 BASE64로 인코딩한 값에 비밀 키를 이용해 헤더에서 정의한 알고리즘으로 해싱한 후 이 값을 다시 BASE64로 인코딩하여 생성한다.

생성된 토큰은 HTTP 통신을 할 때 Authorization이라는 key의 value로 사용된다. 일반적으로 value에는 Bearer이 앞에 붙여진다.

---
## sliding session 전략

AT의 만료시간을 늘려주는 것이다.
마찬가지로 RT의 만료시간도 늘려줄 수 있다.

---
## flow

- 클라이언트가 서버로 로그인
- 서버에서 사용자를 확인하고 AT와 RT를 함께 전송한다. (이 때 DB에 저장)
- 클라이언트는 RT는 로컬에 저장하고, AT로 서버에 로그인 요청!
- 서버에서 토큰 검증 -> 응답
- AT가 만료된 경우면 서버에서 Unauthorized응답
- Unauthorized 응답을 받았으면 RT으로 AT를 재발급
- 만약 RT가 만료되었다면 클라이언트에게 재 로그인 응답, 기존 AT와 RT를 비우고 재 로그인 요청
- 로그아웃을 누르면 RT로 AT를 모두 제거한다.


## JWT단점 및 고려사항
- Self-contained: 토큰 자체에 정보를 담고 있어서 토큰이 탈취된다면 매우 위험.
- 토큰 길이: 페이로드에 3종류의 클레임을 저장하기 때문에 정보가 많을수록 길이가 길어져 성능에 안좋은 영향을 끼칠 수 있다.
- Payload 인코딩: 페이로드 자체는 암호화 된 것이 아니라서 페이로드를 탈취하여 디코딩 후 데이터를 볼 수 있으므로, JWE(Encryption)로 암호화 하거나, payload에 중요 데이터를 넣지 않아야 함.
- Stateless: JWT는 상태를 저장하지 않기 때문에, 한 번 만들면 제어(삭제, 수정)가 불가능하기때문에 만료시간을 "꼭" 넣어야 한다.
- Tore Token: 토큰은 클라이언트에서 관리해야 하기 때문에, 토큰을 저장해야 한다.

참조 : https://mangkyu.tistory.com/56
http://tlog.tammolo.com/blog/jwt/